@startuml Course_CRUD

title Course CRUD Operations Flow

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Admin Client" as Client
participant "CoursesController" as CC
participant "CoursesService" as CS
database "Database" as DB

== Create Course ==
Client -> CC: POST /courses\n{ hskLevel, title, description, prerequisiteCourseId?, orderIndex? }
activate CC

CC -> CS: create(createCourseDto)
activate CS

alt prerequisiteCourseId provided
    CS -> DB: SELECT * FROM courses WHERE id = prerequisiteCourseId
    DB --> CS: prerequisite | null
    alt Prerequisite not found
        CS --> CC: BadRequestException\n"Prerequisite course not found"
        CC --> Client: 400 Bad Request
    end
end

alt orderIndex not provided
    CS -> DB: SELECT MAX(orderIndex) FROM courses
    DB --> CS: maxOrder
    CS -> CS: orderIndex = maxOrder + 1
else orderIndex provided
    CS -> DB: SELECT * FROM courses WHERE orderIndex = ?
    DB --> CS: existing | null
    alt Order index taken
        CS --> CC: BadRequestException\n"Order index already exists"
        CC --> Client: 400 Bad Request
    end
end

CS -> DB: INSERT INTO courses
DB --> CS: saved Course

CS --> CC: Course
deactivate CS
CC --> Client: 201 Created\n{ course data }
deactivate CC

== Get Courses with Pagination ==
Client -> CC: GET /courses?page=1&limit=10&hskLevel=1&isActive=true
activate CC

CC -> CS: findAll(query)
activate CS

CS -> DB: SELECT * FROM courses\nWHERE hskLevel = ? AND isActive = ?\nORDER BY hskLevel, orderIndex\nLIMIT ? OFFSET ?
DB --> CS: [courses], total

CS --> CC: { courses, total }
deactivate CS

CC --> Client: 200 OK\n{ courses: [...], total: 25 }
deactivate CC

== Update Course ==
Client -> CC: PUT /courses/:id\n{ title?, description?, prerequisiteCourseId?, orderIndex? }
activate CC

CC -> CS: update(id, updateCourseDto)
activate CS

CS -> DB: SELECT * FROM courses WHERE id = ?
DB --> CS: course | null

alt Course not found
    CS --> CC: NotFoundException
    CC --> Client: 404 Not Found
else Course exists
    opt Updating prerequisiteCourseId
        alt Self-reference
            CS --> CC: BadRequestException\n"Cannot be own prerequisite"
            CC --> Client: 400 Bad Request
        end
        CS -> DB: Verify prerequisite exists
    end
    
    opt Updating orderIndex
        CS -> DB: Check if new orderIndex is taken
    end
    
    CS -> DB: UPDATE courses SET ...
    DB --> CS: updated Course
    
    CS --> CC: Course
    deactivate CS
    CC --> Client: 200 OK\n{ updated course }
end
deactivate CC

== Soft Delete Course ==
Client -> CC: DELETE /courses/:id
activate CC

CC -> CS: delete(id)
activate CS

CS -> DB: SELECT * FROM courses WHERE id = ?
DB --> CS: course

CS -> DB: SELECT * FROM courses WHERE prerequisiteCourseId = ?
DB --> CS: dependentCourses[]

alt Has dependent courses
    CS --> CC: BadRequestException\n"Cannot delete - is prerequisite for others"
    CC --> Client: 400 Bad Request
else No dependencies
    CS -> DB: UPDATE courses SET isActive = false
    CS --> CC: void
    deactivate CS
    CC --> Client: 204 No Content
end
deactivate CC

== Restore Course ==
Client -> CC: PATCH /courses/:id/restore
activate CC

CC -> CS: restore(id)
activate CS

CS -> DB: SELECT * FROM courses WHERE id = ?
DB --> CS: course

CS -> DB: UPDATE courses SET isActive = true
DB --> CS: restored Course

CS --> CC: Course
deactivate CS
CC --> Client: 200 OK\n{ restored course }
deactivate CC

@enduml
