@startuml SRS_Review_Session

title Spaced Repetition System (SRS) Review Session Flow

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor Client
participant "SrsController" as SC
participant "SrsService" as SS
database "Database" as DB

== Get Due Reviews ==
Client -> SC: GET /srs/reviews/due
activate SC

SC -> SS: getDueReviews(userId)
activate SS

SS -> DB: SELECT urq.*, q.* FROM user_question_reviews urq\nJOIN questions q ON urq.questionId = q.id\nWHERE urq.userId = ? AND urq.nextReviewDate <= NOW()
DB --> SS: dueReviews[]

SS --> SC: DueReviewDto[]
deactivate SS

SC --> Client: 200 OK\n[{ questionId, questionType, data, ... }]
deactivate SC

== Submit Review Result ==
Client -> SC: POST /srs/reviews/submit\n{ questionId, quality: 0-5 }
activate SC

SC -> SS: submitReviewResult(userId, submitReviewDto)
activate SS

alt Quality not in range 0-5
    SS --> SC: BadRequestException
    SC --> Client: 400 Bad Request
else Valid quality
    SS -> DB: SELECT * FROM user_question_reviews\nWHERE userId = ? AND questionId = ?
    DB --> SS: review | null
    
    alt Review not found
        SS --> SC: NotFoundException
        SC --> Client: 404 Not Found\n"Complete lesson first"
    else Review found
        
        == SM-2 Algorithm Calculation ==
        SS -> SS: calculateNextReview(quality, easeFactor, interval, repetitions)
        
        note right of SS
            SM-2 Algorithm:
            1. newEaseFactor = EF + (0.1 - (5-q)*(0.08 + (5-q)*0.02))
            2. If EF < 1.3, set EF = 1.3
            3. If quality < 3: reset (rep=0, interval=1)
            4. Else: rep++, interval based on rep count
        end note
        
        alt quality < 3 (Failed recall)
            SS -> SS: repetitions = 0, interval = 1
        else quality >= 3 (Successful recall)
            SS -> SS: repetitions++
            alt repetitions == 1
                SS -> SS: interval = 1
            else repetitions == 2
                SS -> SS: interval = 6
            else repetitions >= 3
                SS -> SS: interval = round(interval * easeFactor)
            end
        end
        
        SS -> SS: nextReviewDate = today + interval days
        
        SS -> DB: UPDATE user_question_reviews\nSET easeFactor, interval, repetitions,\nnextReviewDate, lastReviewedAt = NOW()
        DB --> SS: updatedReview
        
        SS --> SC: UserQuestionReview
        deactivate SS
        
        SC --> Client: 200 OK\n{ nextReviewDate, interval, easeFactor, repetitions }
    end
end

deactivate SC

== Get Review Statistics ==
Client -> SC: GET /srs/stats
activate SC

SC -> SS: getReviewStats(userId)
activate SS

SS -> DB: SELECT COUNT(*) grouped by status\nFROM user_question_reviews WHERE userId = ?
DB --> SS: stats

SS --> SC: ReviewStatsDto
deactivate SS

SC --> Client: 200 OK\n{ totalQuestions, dueToday, learning, mature }
deactivate SC

@enduml
