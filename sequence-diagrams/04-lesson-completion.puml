@startuml Lesson_Completion

title Lesson Completion and SRS Initialization Flow

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor Client
participant "UsersController" as UC
participant "UserProgressService" as UPS
participant "SrsService" as SRS
database "Database" as DB

Client -> UC: POST /users/progress/lesson/{lessonId}/complete\n{ scorePercentage }
note right: JWT token in header\nuserId extracted from token
activate UC

UC -> UPS: completeLesson(userId, lessonId, scorePercentage)
activate UPS

== Verify User and Lesson ==
par Parallel verification
    UPS -> DB: SELECT * FROM users WHERE id = ?
    UPS -> DB: SELECT * FROM lessons WHERE id = ?
end
DB --> UPS: user, lesson

alt User not found
    UPS --> UC: NotFoundException("User not found")
    UC --> Client: 404 Not Found
else Lesson not found
    UPS --> UC: NotFoundException("Lesson not found")
    UC --> Client: 404 Not Found
else Both exist
    
    == Find or Create Progress Record ==
    UPS -> DB: SELECT * FROM user_lesson_progress\nWHERE userId = ? AND lessonId = ?
    DB --> UPS: progress | null
    
    alt Progress exists
        UPS -> UPS: Update status, score, completedAt
    else New progress
        UPS -> UPS: Create new progress record
    end
    
    UPS -> DB: INSERT/UPDATE user_lesson_progress
    DB --> UPS: savedProgress
    
    == Update Study Streak ==
    UPS -> UPS: updateStudyStreak(userId, now)
    UPS -> DB: SELECT * FROM users WHERE id = ?
    DB --> UPS: user with streak data
    
    UPS -> UPS: Calculate days difference\nfrom lastStudyDate
    
    alt First study session
        UPS -> UPS: streak = 1, totalStudyDays = 1
    else Consecutive day
        UPS -> UPS: streak++, totalStudyDays++
    else Gap > 1 day
        UPS -> UPS: streak = 1, totalStudyDays++
    end
    
    UPS -> DB: UPDATE users SET streak, longestStreak, totalStudyDays
    
    == Initialize SRS Reviews ==
    UPS -> SRS: initializeLessonQuestionsForReview(userId, lessonId)
    activate SRS
    
    SRS -> DB: SELECT * FROM questions\nWHERE lessonId = ? AND isActive = true
    DB --> SRS: questions[]
    
    loop For each question
        SRS -> DB: SELECT * FROM user_question_reviews\nWHERE userId = ? AND questionId = ?
        DB --> SRS: existing | null
        
        alt Not exists
            SRS -> SRS: Create review with SM-2 defaults\n(easeFactor: 2.5, interval: 1)
            SRS -> DB: INSERT user_question_reviews\nnextReviewDate = tomorrow
        end
    end
    
    SRS --> UPS: reviews[]
    deactivate SRS
    
    UPS --> UC: UserLessonProgress
    deactivate UPS
    
    UC --> Client: 200 OK\n{ progress data }
end

deactivate UC

@enduml
