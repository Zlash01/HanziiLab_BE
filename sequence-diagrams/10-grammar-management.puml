@startuml Grammar_Management

title Grammar Pattern Management with Translations

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Admin Client" as Client
participant "GrammarPatternsController" as GPC
participant "GrammarPatternsService" as GPS
participant "GrammarTranslationsController" as GTC
participant "GrammarTranslationsService" as GTS
database "Database" as DB

== Create Grammar Pattern with Translation ==
Client -> GPC: POST /grammar-patterns\n{\n  pattern: ["Subject", "是", "Object"],\n  patternPinyin: ["Subject", "shì", "Object"],\n  patternFormula: "S + 是 + O",\n  hskLevel: 1,\n  translations: [{\n    language: "en",\n    grammarPoint: "to be (是)",\n    explanation: "Used to link subject with noun...",\n    example: {...}\n  }]\n}
activate GPC

GPC -> GPS: create(createGrammarPatternDto)
activate GPS

GPS -> DB: INSERT INTO grammar_patterns\n(pattern, patternPinyin, patternFormula, hskLevel)
DB --> GPS: savedPattern

opt translations provided
    loop For each translation
        GPS -> GTS: Create translation
        activate GTS
        
        GTS -> DB: INSERT INTO grammar_translations\n(grammarPatternId, language, grammarPoint, explanation, example)
        DB --> GTS: savedTranslation
        
        GTS --> GPS: translation
        deactivate GTS
    end
end

GPS -> DB: SELECT pattern with translations
DB --> GPS: completePattern

GPS --> GPC: GrammarPattern with translations
deactivate GPS
GPC --> Client: 201 Created\n{ id, pattern, translations: [...] }
deactivate GPC

== Get Grammar Patterns by HSK Level ==
Client -> GPC: GET /grammar-patterns?hskLevel=1&page=1&limit=10
activate GPC

GPC -> GPS: findAll(query)
activate GPS

GPS -> DB: SELECT * FROM grammar_patterns\nWHERE hskLevel = ?\nLEFT JOIN grammar_translations\nORDER BY id\nLIMIT ? OFFSET ?
DB --> GPS: [patterns], total

GPS --> GPC: { patterns, total, page, limit }
deactivate GPS
GPC --> Client: 200 OK\n{ data: [...], total, page, limit }
deactivate GPC

== Get Grammar Pattern by ID ==
Client -> GPC: GET /grammar-patterns/:id
activate GPC

GPC -> GPS: findOne(id)
activate GPS

GPS -> DB: SELECT * FROM grammar_patterns\nWHERE id = ?\nLEFT JOIN grammar_translations
DB --> GPS: pattern | null

alt Pattern not found
    GPS --> GPC: NotFoundException
    GPC --> Client: 404 Not Found
else Pattern found
    GPS --> GPC: pattern with translations
    deactivate GPS
    GPC --> Client: 200 OK\n{ pattern data }
end
deactivate GPC

== Add Translation to Grammar Pattern ==
Client -> GTC: POST /grammar-translations\n{\n  grammarPatternId: 1,\n  language: "vn",\n  grammarPoint: "là (是)",\n  explanation: "Dùng để nối chủ ngữ...",\n  example: {...}\n}
activate GTC

GTC -> GTS: create(createTranslationDto)
activate GTS

GTS -> DB: SELECT * FROM grammar_patterns WHERE id = ?
DB --> GTS: pattern | null

alt Pattern not found
    GTS --> GTC: NotFoundException\n"Grammar pattern not found"
    GTC --> Client: 404 Not Found
else Pattern exists
    GTS -> DB: SELECT * FROM grammar_translations\nWHERE grammarPatternId = ? AND language = ?
    DB --> GTS: existing | null
    
    alt Translation exists
        GTS --> GTC: ConflictException\n"Translation already exists for this language"
        GTC --> Client: 409 Conflict
    else New translation
        GTS -> DB: INSERT INTO grammar_translations
        DB --> GTS: savedTranslation
        
        GTS --> GTC: translation
        deactivate GTS
        GTC --> Client: 201 Created\n{ translation data }
    end
end
deactivate GTC

== Update Grammar Translation ==
Client -> GTC: PUT /grammar-translations/:id\n{ explanation: "Updated explanation...", example: {...} }
activate GTC

GTC -> GTS: update(id, updateTranslationDto)
activate GTS

GTS -> DB: SELECT * FROM grammar_translations WHERE id = ?
DB --> GTS: translation | null

alt Translation not found
    GTS --> GTC: NotFoundException
    GTC --> Client: 404 Not Found
else Translation found
    GTS -> DB: UPDATE grammar_translations SET ...
    DB --> GTS: updatedTranslation
    
    GTS --> GTC: translation
    deactivate GTS
    GTC --> Client: 200 OK\n{ updated translation }
end
deactivate GTC

== Delete Grammar Pattern (Cascade) ==
Client -> GPC: DELETE /grammar-patterns/:id
activate GPC

GPC -> GPS: remove(id)
activate GPS

GPS -> DB: SELECT * FROM grammar_patterns WHERE id = ?
DB --> GPS: pattern | null

alt Pattern not found
    GPS --> GPC: NotFoundException
    GPC --> Client: 404 Not Found
else Pattern found
    GPS -> DB: DELETE FROM grammar_patterns WHERE id = ?
    note right: CASCADE deletes all translations
    DB --> GPS: deleted
    
    GPS --> GPC: void
    deactivate GPS
    GPC --> Client: 204 No Content
end
deactivate GPC

@enduml
